<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="leaderboard-create-group"
                 attributes="userDetails roundToScore tournamentToScore tournamentPlayers tournamentPlayersLength groupTournamentScore groupPlayerToSet userGrouping">
  <template>
    <link rel="stylesheet" href="leaderboard-create-group.css">

    <section id="createGroupSection"
             class="create-group-section  {{ {wide: wide} | tokenList }}"
             layout vertical>

      <section id="availablePlayersList"
                 class="players-list"
                 flex>
        <template repeat="{{player in availablePlayers}}">
          <div class="players-list__row {{ {selected: selected} | tokenList }}"
               playerId="{{player.uid}}"
               on-tap="{{playerSelected}}">
            <div class="players-list__item" layout horizontal>
              <div class="player-name" flex>{{player.name}}</div>
              <div class="player-handicap">{{player.handicap}}</div>
            </div>
            <div class="divider"></div>
          </div>
        </template>
      </section>

      <div class="players-selected-footer">
        <div layout horizontal>
          <div class="player-selected" flex>{{userGrouping.players[0] ? userGrouping.players[0].name : pickedPlayerDefaults.player1 }}</div>
          <div class="player-selected" flex>{{userGrouping.players[1] ? userGrouping.players[1].name : pickedPlayerDefaults.player2 }}</div>
        </div>
        <div layout horizontal>
          <div class="player-selected" flex>{{userGrouping.players[2] ? userGrouping.players[2].name : pickedPlayerDefaults.player3 }}</div>
          <div class="player-selected" flex>{{userGrouping.players[3] ? userGrouping.players[3].name : pickedPlayerDefaults.player4 }}</div>
        </div>
      </div>

    </section>

  </template>
  <script>
    (function () {
      'use strict';

      Polymer({

        availablePlayers: [],

        tournamentPlayersLength: 0,

        groupingId: '',

        pickedPlayerDefaults: {
          player1: 'Player 1',
          player2: 'Player 2',
          player3: 'Player 3',
          player4: 'Player 4'
        },

        // When tournamentPlayers array has finished populating
        tournamentPlayersChanged: function() {
          if (this.tournamentPlayersLength === this.tournamentPlayers.length) {
            this.getAvailablePlayers();
          }
        },

        // Iterate the player ids of tournamentPlayers and if they exist in any of the groupings collection property in
        // the players collection, set the availablePlayers array
        getAvailablePlayers: function() {

          if (this.roundToScore && this.roundToScore.groupings) {
            this.availablePlayers = this.tournamentPlayers;
            this.removePickedPlayers();
          } else {
            this.availablePlayers = this.tournamentPlayers;
          }
        },

        // If player already exists in a grouping, filter them from the availablePlayers array
        removePickedPlayers: function() {

          for (var grouping in this.roundToScore.groupings) {

            this.roundToScore.groupings[grouping].players.forEach(function(pickedPlayer) {

              this.availablePlayers = this.availablePlayers.filter(function (player) {
                return player.uid !== pickedPlayer.uid;
              });
            }, this);
          }
        },

        // When a player is selected from this list, their user object is copied over to the players collection of the
        // groupings collection in roundToScore
        playerSelected: function(event) {

          var playerObject = event.currentTarget.attributes.playerId.value;

          // If first player is being added to this round, trigger 'create-new-group' event
          if (!this.userGrouping) {

            // Create array for players object containing the first record
            this.groupPlayerToSet = {
              players: [playerObject]
            };
            this.fire('create-new-group');
          } else {
            this.userGrouping.players.push(playerObject);
            this.updateAvailablePlayers(playerObject, 'remove');
            this.fire('add-player-to-group');
          }
        },

        // Update availablePlayers Collection when a player is added or removed
        updateAvailablePlayers: function(player, action) {

          if (action === 'add') {
            this.availablePlayers.push(player);
          } else if (action === 'remove') {
            this.availablePlayers = this.availablePlayers.filter(function (availablePlayer) {
              return availablePlayer.uid !== player.uid;
            });
          }
        }

      });

    })();
  </script>
</polymer-element>
