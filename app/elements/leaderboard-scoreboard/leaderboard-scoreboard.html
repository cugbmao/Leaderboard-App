<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="leaderboard-scoreboard" attributes="userDetails wide">
  <template>
    <link rel="stylesheet" href="leaderboard-scoreboard.css">

    <firebase-element id="fbLeaderboard" location="{{offline ? null : 'https://polymer-topeka.firebaseio.com/users'}}" on-data-change="{{leaderboardChange}}" data="{{leaderboard}}" limit="{{limit}}"></firebase-element>

    <div class="bg" fit dummy cross-fade></div>

    <div class="main {{ {scroll: wide} | tokenList }}" flex center layout vertical hero-p>
      <div flex vertical layout
           slide-up-offscreen?="{{parentElement.selected === 'scoreboard'}}"
           cross-fade="{{!wide && parentElement.selected !== 'scoreboard'}}"
           class="card {{ {wide: wide, 'multi-column': columns>1, tvmode: tvmode} | tokenList }}"
           relative>

        <core-toolbar>
          <div class="section-title">Leaderboard</div>
        </core-toolbar>

        <div class="{{ {scroll: !wide} | tokenList }}" layout vertical flex>

          <core-animated-pages id="pages"
                               selected="{{selected}}"
                               on-core-animated-pages-transition-end="{{done}}"
                               transitions="hero-transition"
                               layout
                               flex
                               no-transition?="{{disabled}}">

            <section class="list" layout>
              <template repeat="{{u,i in items1}}">
                <div hero hero-id="{{u.uid}}"
                     class="item {{u.rising ? 'rising':''}}"
                     style="{{ columns>1 ? 'width:' + (1/columns*100) + '%' : '' }}"
                     layout horizontal center>
                  <div class="rank">
                    <div class="rankNo">{{i+1}}</div>
                    <core-icon class="arrow" icon="arrow-back"></core-icon>
                  </div>
                  <div layout flex class="name">{{u.name}}</div>
                  <div class="delta" hidden?="{{!u.delta || !u.rising}}">{{u.delta}}</div>
                  <div>{{u.score}}</div>
                </div>
              </template>
            </section>

            <section class="list" layout>
              <template repeat="{{u,i in items2}}">
                <div hero hero-id="{{u.uid}}"
                     class="item {{u.rising ? 'rising':''}}"
                     style="{{ columns>1 ? 'width:' + (1/columns*100) + '%' : '' }}"
                     layout horizontal center>
                  <div class="rank">
                    <div class="rankNo">{{i+1}}</div>
                    <core-icon class="arrow" icon="arrow-back"></core-icon>
                  </div>
                  <div layout flex class="name">{{u.name}}</div>
                  <div class="delta" hidden?="{{!u.delta || !u.rising}}">{{u.delta}}</div>
                  <div>{{u.score}}</div>
                </div>
              </template>
            </section>

          </core-animated-pages>

        </div>
      </div>

      <paper-icon-button class="back-button {{ {wide: wide} | tokenList }}"
                         icon="arrow-back"
                         hidden?="{{tvmode}}"
                         on-tap="{{backNavigation}}"
                         hero-id="scoreboard-back-button"
                         hero>
      </paper-icon-button>
    </div>

  </template>

  <script>
    (function () {

      Polymer({

        publish: {
          disabled: false,
          limit: 20,
          columns: 1,
          tvmode: false,
          duration: -1,
          user: null,
          wide: false,
          offline: false
        },

        observe: {
          'limit offline': 'updateLeaderboard'
        },

        selected: 0,

        MAX: 1800,

        names: ['James','John','Robert','Michael','William','David','Richard','Joseph','Charles','Thomas','Christopher','Daniel','Matthew','Donald','Anthony','Paul','Mark','George','Steven','Kenneth','Andrew','Edward','Joshua','Brian','Kevin','Ronald','Timothy','Jason','Jeffrey','Gary','Ryan','Nicholas','Eric','Jacob','Stephen','Jonathan','Larry','Frank','Scott','Justin','Brandon','Raymond','Gregory','Samuel','Benjamin','Patrick','Jack','Dennis','Jerry','Alexander','Tyler','Henry','Douglas','Peter','Aaron','Walter','Jose','Adam','Zachary','Harold','Nathan','Kyle','Carl','Arthur','Gerald','Roger','Lawrence','Keith','Albert','Jeremy','Terry','Joe','Sean','Willie','Jesse','Austin','Christian','Ralph','Billy','Bruce','Bryan','Roy','Eugene','Ethan','Louis','Wayne','Jordan','Harry','Russell','Alan','Juan','Philip','Randy','Dylan','Howard','Vincent','Bobby','Johnny','Phillip','Shawn','Mary','Patricia','Jennifer','Elizabeth','Linda','Barbara','Susan','Margaret','Jessica','Dorothy','Sarah','Karen','Nancy','Betty','Lisa','Sandra','Helen','Ashley','Donna','Kimberly','Carol','Michelle','Emily','Amanda','Melissa','Deborah','Laura','Stephanie','Rebecca','Sharon','Cynthia','Kathleen','Ruth','Anna','Shirley','Amy','Angela','Virginia','Brenda','Pamela','Catherine','Katherine','Nicole','Christine','Janet','Debra','Samantha','Carolyn','Rachel','Heather','Maria','Diane','Frances','Joyce','Julie','Emma','Evelyn','Martha','Joan','Kelly','Christina','Lauren','Judith','Alice','Victoria','Doris','Ann','Jean','Cheryl','Marie','Megan','Kathryn','Andrea','Jacqueline','Gloria','Teresa','Janice','Sara','Rose','Hannah','Julia','Theresa','Judy','Grace','Beverly','Denise','Marilyn','Mildred','Amber','Danielle','Brittany','Olivia','Diana','Jane','Lori','Madison','Tiffany','Kathy','Tammy','Crystal'],

        ready: function() {
          this.lastScores = {};
          if (!this.offline) {
            this.offline =
              window.location.search.indexOf('offline') >= 0 ||
              window.location.search.indexOf('test') >= 0;
          }
        },

        updateLeaderboard: function() {
          if (this.offline) {
            this.generateLeaderboard();
          } else {
            if (this.bumpTimeout) {
              clearTimeout(this.bumpTimeout);
            }
            this.items1 = this.items2 = this.queuedItems = null;
          }
        },

        generateLeaderboard: function() {
          var lb = {};
          var n = this.names.slice();
          for (var i=0; i<this.limit; i++) {
            var f = Math.floor(Math.random()*n.length);
            var l = Math.floor(Math.random()*26);
            lb['u'+i] = {
              name: n.splice(f, 1)[0] + ' ' + String.fromCharCode(65 + l),
              avatar: Math.floor(Math.random()*16)+1,
              score: 0};
          }
          this.leaderboard = lb;
          this.bumpScores();
        },

        disabledChanged: function() {
          if (!this.disabled) {
            this.holdoff = true;
            setTimeout(function() {
              this.holdoff = false;
            }.bind(this), 2000);
            if (this.offline) {
              this.bumpScores();
            }
            if (this.queuedItems) {
              this.items1 = this.items2 = this.queuedItems;
              this.queuedItems = null;
            }
          } else {
            this.selected = 0;
          }
        },

        userChanged: function() {
          if (this.offline && this.user) {
            this.leaderboard.me = this.user;
          }
        },

        bumpScores: function() {
          for (uid in this.leaderboard) {
            var u = this.leaderboard[uid];
            if ((Math.random() > (1-1/this.limit)) && (!this.user || uid != 'me')) {
              u.score += 8;
            }
          }
          this.leaderboardChange();
          this.bumpTimeout = setTimeout(function() {
            if (!this.disabled) {
              this.bumpScores();
            }
          }.bind(this), Math.random() * 5000);
        },

        leaderboardChange: function() {
          if (!this.leaderboard) {
            // Leaderboard was nuked
            this.items1 = this.items2 = this.queuedItems = null;
            return;
          }
          var data = this.leaderboard;
          var uids = Object.keys(data);
          this.newScores = {};
          var items = uids.map(function(u) {
            this.newScores[u] = data[u].score;
            return { uid: u, name: data[u].name, avatar: data[u].avatar, score: data[u].score};
          }.bind(this)).sort(function(a, b) {
            return b.score - a.score || a.name && b.name && a.name.localeCompare(b.name);
          });
          if (this.holdoff) {
            if (!this.items1) {
              this.items1 = items;
            } else {
              this.items2 = items;
            }
          } else if (this.$.pages.transitioning.length || this.disabled) {
            this.queuedItems = items;
          } else {
            this.flipPages(items);
          }
        },

        flipPages: function(newItems) {
          var order = newItems.map(function(u) {
            return u.uid;
          });
          if (this.lastOrder) {
            newItems.forEach(function(u, i) {
              var idx = this.lastOrder.indexOf(u.uid);
              if (idx < -1 || idx > i) {
                u.delta = this.newScores[u.uid] - this.lastScores[u.uid] || 0;
                u.rising = true;
                if (u.delta > 0) {
                  u.delta = "+" + u.delta;
                }
              }
            }.bind(this));
          }
          this.lastOrder = order;
          if (this.selected || !this.items1) {
            this.items1 = newItems;
          }
          if (!this.selected || !this.items2) {
            this.items2 = newItems;
          }
          this.selected = this.selected ? 0 : 1;
        },

        done: function() {
          this.lastScores = this.newScores;
          if (this.queuedItems) {
            this.flipPages(this.queuedItems);
            this.queuedItems = null;
          } else {
            if (this.selected) {
              this.items1 = this.items2;
            } else {
              this.items2 = this.items1;
            }
          }
        },

        mainAction: function() {
          if (this.$.pages.transitioning.length > 0) {
            this.$.pages.complete();
          }
          this.disabled = true;
          this.fire('main');
        },

        durationChanged: function() {
          if (this.duration > 0) {
            CoreStyle.g.transitions.duration = this.duration;
          }
        },

        backNavigation: function() {
          window.history.back();
        }
      });

    })();
  </script>
</polymer-element>
