<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="leaderboard-score-group"
                 attributes="userDetails holeNumber tournamentToScore roundToScore userGrouping">
  <template>
    <link rel="stylesheet" href="leaderboard-score-group.css">
      <div id="GroupContent" class="group-content" flex vertical layout>
        <div class="card" flex vertical layout>
          <div class="group-view" flex>
            <div class="four-quarter">
              <div id="players" fit horizontal wrap layout>
                <template repeat="{{player in players}}">
                  <div class="player" layout vertical>
                    <div class="player__info" layout horizontal>
                      <div class="player__name">{{player.name}}</div>
                      <div class="player__handicap">{{player.handicap}}</div>
                      <div class="player__score" flex>{{player.totalScore ? player.totalScore: '0'}} pts</div>
                    </div>
                    <div class="player__score" layout vertical flex>
                      <div class="player__score-input-container" layout horizontal center-center flex>
                        <div class="player__score-input-minus"
                             playerHoleScore="{{player.roundScorecard[holeNumber - 1]}}"
                             playerId="{{player.uid}}"
                             on-tap="{{scoreMinusOne}}">
                          <paper-fab mini icon="remove"></paper-fab>
                        </div>
                        <div class="player__score-input" flex>
                          {{player.roundScorecard[holeNumber - 1] ? player.roundScorecard[holeNumber - 1] : '-'}}
                        </div>
                        <div class="player__score-input-plus"
                             playerHoleScore="{{player.roundScorecard[holeNumber - 1]}}"
                             playerId="{{player.uid}}"
                             on-tap="{{scoreAddOne}}">
                          <paper-fab mini icon="add"></paper-fab></div>
                      </div>
                      <!-- ToDo - Look into a tall media query so we can add quick buttons -->
                      <div showing?="{{tall}}" class="player__score-quick-button-container" layout horizontal>
                        <div class="player__score-quick-button  player__score-quick-button--birdie" flex>
                          <span>-1</span>
                        </div>
                        <div class="player__score-quick-button  player__score-quick-button--par" flex>
                          <span>par</span>
                        </div>
                        <div class="player__score-quick-button  player__score-quick-button--bogey" flex>
                          <span>+1</span>
                        </div>
                        <div class="player__score-quick-button  player__score-quick-button--double-bogey" flex>
                          <span>+2</span>
                        </div>
                        <div class="player__score-quick-button  player__score-quick-button--blob" flex>
                          <span>blob</span>
                        </div>
                      </div>
                    </div>
                    <div class="player__shots-on-hole">
                      Shots on this hole: <span>{{player.shotsOnCurrentHole}}</span>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>
      <div class="score-navigation-footer" layout vertical>
        <div class="hole-number-navigation">
          <div layout horizontal>
            <template repeat="{{hole, holeIndex in holeNumbers}}">
              <div class="hole-number"
                   hole="{{holeIndex + 1}}"
                   on-tap="{{showHoleNumber}}"
                   horizontal center-justified center layout flex>
                <div class="ink-container">
                  <paper-ripple class="circle recenteringTouch" fit></paper-ripple>
                </div>
                <div class="hole-number__text  {{holeIndex + 1 === holeNumber ? 'hole-number__text--selected' : ''}}">{{holeIndex + 1}}</div>
              </div>
            </template>
          </div>
          <div layout horizontal>
            <template repeat="{{hole, holeIndex in holeNumbers}}">
              <div class="hole-number"
                   hole="{{holeIndex + 10}}"
                   on-tap="{{showHoleNumber}}"
                   horizontal center-justified center layout flex>
                <div class="ink-container">
                  <paper-ripple class="circle recenteringTouch" fit></paper-ripple>
                </div>
                <div class="hole-number__text  {{holeIndex + 10 === holeNumber ? 'hole-number__text--selected' : ''}}">{{holeIndex + 10}}</div>
              </div>
            </template>
          </div>
        </div>
        <div flex>
          <div class="button-container" layout horizontal>
            <paper-button showing?="{{holeNumber > 1}}"
                          raised
                          class="button-container__button  previous-hole-button"
                          on-tap="{{showPreviousHole}}"
                          transition="core-transition-center"
                          flex>
                          <core-icon icon="arrow-back"></core-icon>
                          {{holeNumber === 1 ? holeNumberText[1] : holeNumberText[holeNumber - 1]}}</paper-button>
            <paper-button raised
                          class="scorecard-button"
                          on-tap="{{showScorecard}}"
                          transition="core-transition-center"
                          flex>Card</paper-button>
            <paper-button raised
                          class="scorecard-button"
                          on-tap="{{showScorecard}}"
                          transition="core-transition-center"
                          flex>Live</paper-button>
            <paper-button showing?="{{holeNumber <= 18}}"
                          raised
                          class="button-container__button  next-hole-button"
                          on-tap="{{showNextHole}}"
                          transition="core-transition-center"
                          flex>{{holeNumber === 18 ? 'Done' : holeNumberText[holeNumber + 1]}}
                          <core-icon showing?="{{holeNumber < 18}}" icon="arrow-forward"></core-icon>
            </paper-button>
          </div>
        </div>
      </div>
    </div>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({

        // Number of hole being scored
        holeNumber: 0,

        // Keep record of previos hole number so it can be used after navigating away
        previousHoleNumber: 0,

        // Array to use for template to jump to holes navigation
        holeNumbers: [],

        // Array to use for template to jump to holes navigation
        nineHole: false,

        // Array to use for players to be used in template binding
        players: [],

        roundToScore: null,

        // Object to use to display hole numbers
        holeNumberText: {
          1: '1st',
          2: '2nd',
          3: '3rd',
          4: '4th',
          5: '5th',
          6: '6th',
          7: '7th',
          8: '8th',
          9: '9th',
          10: '10th',
          11: '11th',
          12: '12th',
          13: '13th',
          14: '14th',
          15: '15th',
          16: '16th',
          17: '17th',
          18: '18th'
        },

        // When holeNumber changes sync up some updates
        holeNumberChanged: function() {

          this.players.forEach(function(player) {
            this.setShotsOnCurrentHole(player);
          }, this);

          this.updateHoleScore();
        },

        // Set property on each player to show how many shots they receive on the current hole
        setShotsOnCurrentHole: function(player) {
          player.shotsOnCurrentHole = this.getShots(player.handicap, this.holeNumber);
        },

        // Calculate shots based on relevant factors
        getShots: function(handicap, holeNumber) {

          var strokeIndex = parseInt(this.roundToScore.stroke[holeNumber - 1], 10);

          // Add 0.01 if the handicap is same as stroke so it will ceil() to 1 instead of 0.
          var shots = Math.ceil(((handicap - strokeIndex) / 18) + 0.01);

          return shots;
        },

        // If a round to score is changed
        roundToScoreUpdated: function() {

          if (this.roundToScore) {
            console.log(this.roundToScore.groupings[this.userDetails.uid].players);

            // Set arrays to use for jump to hole navigation
            this.holeNumbers.length = '9';

            if (this.roundToScore['length'] > 9) {
              this.nineHole = true;
            }

            // If roundToScore changes update players so the template binding is updated
            if (this.roundToScore.groupings) {
              this.players = this.roundToScore.groupings[this.userDetails.uid].players;
            }
          }

          this.players.forEach(function(player) {

            // Update shots for each player
            this.setShotsOnCurrentHole(player);

            // Update Total Score for each player
            this.setTotalRoundScore(player);

          }, this);
        },

        // Transition to specific hole number
        showHoleNumber: function(event) {
          this.previousHoleNumber = this.holeNumber;
          this.holeNumber = parseInt(event.currentTarget.attributes.hole.value, 10);
        },

        // Transition to previous hole
        showPreviousHole: function() {
          this.previousHoleNumber = this.holeNumber;
          this.holeNumber = this.holeNumber - 1;
        },

        // Transition to next hole
        showNextHole: function() {

          if (this.holeNumber === 18) {
            this.completeRound();
            return;
          }

          this.previousHoleNumber = this.holeNumber;
          this.holeNumber = this.holeNumber + 1;
        },

        // Add one to a players score
        scoreAddOne: function(event, detail) {

          var currentScore = event.currentTarget.attributes.playerHoleScore.value;
          var playerId = event.currentTarget.attributes.playerId.value;
          var player = this.getPlayerById(playerId);
          var par = this.roundToScore.par[this.holeNumber -1];

          if (currentScore) {
            player.roundScorecard[this.holeNumber - 1] = player.roundScorecard[this.holeNumber - 1] + 1;

          // If no score has been entered for this hole add one to the par score for this player
          } else {

            if (!player.roundScorecard) {
              player.roundScorecard = [];
            }

            player.roundScorecard[this.holeNumber - 1] = parseInt(par, 10) + 1;
          }
        },

        // Remove one from a players score
        scoreMinusOne: function(event, detail) {

          var currentScore = event.currentTarget.attributes.playerHoleScore.value;
          var playerId = event.currentTarget.attributes.playerId.value;
          var player = this.getPlayerById(playerId);
          var par = this.roundToScore.par[this.holeNumber -1];

          if (currentScore) {
            if (player.roundScorecard[this.holeNumber - 1] > 0) {
              player.roundScorecard[this.holeNumber - 1] = player.roundScorecard[this.holeNumber - 1] - 1;
            }
          } else {

            if (!player.roundScorecard) {
              player.roundScorecard = [];
            }

            player.roundScorecard[this.holeNumber - 1] = parseInt(par, 10);
          }
        },

        // Iterate through a players collection and return the player object by Id
        getPlayerById: function(playerId) {
          return this.players.filter(function(player) {
            return player.uid === playerId;
          }, this)[0];
        },

        updateHoleScore: function() {

          var playersScoredOnHole = [];

          this.players.forEach(function(player) {
            if (player.roundScorecard && player.roundScorecard[this.previousHoleNumber - 1]) {
              playersScoredOnHole.push(player.roundScorecard[this.previousHoleNumber - 1]);
            }
          }, this);

          // If all scores added to a hole
          if (this.players.length > 0 && this.players.length === playersScoredOnHole.length) {

            // For each player, update the points, e.g Stableford
            this.players.forEach(function(player) {
              this.updateRoundScore(player, this.previousHoleNumber);
              this.setTotalRoundScore(player);
            }, this);

            // Update holesCompleted
            if (!this.userGrouping.holesCompleted) {
              this.userGrouping.holesCompleted = [];
            }

            this.userGrouping.holesCompleted[this.previousHoleNumber - 1] = 'true';

            // Sync the players score
            this.userGrouping.players = this.players;
            this.fire('hole-score-completed');
          }
        },

        // Calculate score for round for a player
        // ToDo - Stableford done, StrokePlay, etc.
        updateRoundScore: function(player, holeNumber) {

          var par = this.roundToScore.par[holeNumber - 1];
          var score = player.roundScorecard[holeNumber - 1];
          var shots = this.getShots(player.handicap, holeNumber);
          var stableFordPointsMap = {
            '1': 1,
            '0': 2,
            '-1': 3,
            '-2': 4,
            '-3': 5,
            '-4': 6
          };
          var roundScore = stableFordPointsMap[(score - shots) - par] || 0;

          // Set roundScore array property on the player
          if (!player.roundScore) {
            player.roundScore = [];
          }

          player.roundScore[holeNumber - 1] = roundScore;
        },

        // Calculate total score for all rounds for a player
        // ToDo - Stableford done, StrokePlay, etc.
        setTotalRoundScore: function(player) {
          if (player.roundScore) {
            player.totalScore = player.roundScore.reduce(function (previousValue, currentValue, index, array) {
              return previousValue + currentValue;
            });
          }
        },

        // Decide whether round is full complete
        completeRound: function() {
          console.log('round complete');
        }
      });

    })();
  </script>
</polymer-element>
