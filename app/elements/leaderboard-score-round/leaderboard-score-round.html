<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="leaderboard-score-round" attributes="userDetails wide">
  <template>
    <link rel="stylesheet" href="leaderboard-score-round.css">

    <firebase-element id="userTournamentsFireBase"
                      location="{{userDetails ? 'https://incandescent-heat-3687.firebaseio.com/users/' + userDetails.uid + '/tournaments' : null}}"
                      dataReady="{{userTournamentsReady}}"
                      data="{{userTournaments}}">
    </firebase-element>

    <div id="sectionPanel" class="section-panel {{ {wide: wide} | tokenList }}"
         flex vertical layout>

      <div class="background-fade  background-fade--themed"
           fit
           cross-fade></div>

      <div class="card" flex vertical layout hero-p>

        <core-toolbar class="menu-toolbar" hero-id="scoreround-title" hero>

          <div class="section-title" flex cross-fade-delayed>Score Round</div>

        </core-toolbar>

        <div id="sectionContent"
             class="section-content"
             flex
             hero-id="scoreround-background"
             hero="{{!wide}}">

          <core-animated-pages class="score-round-pages"
                               selected="{{selected}}"
                               transitions="slide-from-right"
                               on-core-animated-pages-transition-end="{{slideAnimationComplete}}"
                               auto>

            <leaderboard-select-round id="selectRound"
                                      class="score-round-view"
                                      name="selectRound"
                                      upcomingTournaments="{{upcomingTournaments}}"
                                      tournamentToScoreId="{{tournamentToScoreId}}"
                                      roundToScoreId="{{roundToScoreId}}"
                                      on-create-group="{{createGroup}}">
            </leaderboard-select-round>

            <leaderboard-select-round id="selectRound"
                                      name="selectRound">
            </leaderboard-select-round>

          </core-animated-pages>

        </div>

        <paper-fab class="check-button"
                   icon="{{icon}}"></paper-fab>


        <paper-icon-button class="back-button"
                           icon="arrow-back"
                           on-tap="{{backNavigation}}"
                           hero-id="scoreround-back-button"
                           hero>
        </paper-icon-button>

        <paper-icon-button class="home-button"
                           icon="home"
                           on-tap="{{homeNavigation}}"
                           cross-fade>
        </paper-icon-button>

      </div>
    </div>
  </template>
  <script>
    (function () {

      Polymer({

        observe: {
          'userTournaments': 'getUserTournaments'
        },

        userDetails: null,

        roundToScore: null,

        tournamentToScore: null,

        upcomingTournaments: [],

        usersLocation: 'https://incandescent-heat-3687.firebaseio.com/users/',

        tournamentsLocation: 'https://incandescent-heat-3687.firebaseio.com/tournaments/',

        sectionData: {
          'selectRound': {
            'selectedHash': 'score-round',
            'name': 'selectRound',
            'title': 'Select A Round'
          },
          'createGroup': {
            'selectedHash': 'score-round/create-group',
            'name': 'createGroup',
            'title': 'Create Your Group'
          },
          'scoreGroup': {
            'selectedHash': 'score-round/score-group',
            'name': 'scoreGroup',
            'title': 'Score The Round'
          }
        },

        // Get an array of a user's associated tournament ids
        getUserTournaments: function() {

          var userTournamentKeys = [];

          for (var tournamentKey in this.userTournaments) {
            userTournamentKeys.push(tournamentKey);
          }

          // For each tournament key, call the getTournamentObject method
          userTournamentKeys.forEach(this.getTournamentObject, this);
        },

        // Push a tournament object onto the upcomingTournaments collection
        getTournamentObject: function(userTournamentKey) {

          var tournament = new Firebase(this.tournamentsLocation + userTournamentKey);
          var self = this;

          tournament.once('value', function(snap) {
            var result = snap.val();
            self.upcomingTournaments.push(result);
          });
        },

        // Set tournamentToScore and roundToScore properties and navigate to create-group route
        createGroup: function() {
          this.setTournamentToScore();
          this.setRoundToScore();
        },

        // Set tournamentToScore object
        setTournamentToScore: function() {
          this.upcomingTournaments.forEach(function(tournament) {
            if (tournament.id === this.tournamentToScoreId) {
              this.tournamentToScore = tournament;
            }
          }, this);
        },

        // Set roundToScore object
        setRoundToScore: function() {
          this.tournamentToScore.rounds.forEach(function(round) {
            if (this.roundToScoreId === round.roundId) {
              this.roundToScore = round;
            }
          }, this);
        },

        // Handler for back button in toolbar
        backNavigation: function() {
          window.history.back();
        },

        // Handler for home button in toolbar. If on top level route, go straight to menu. Otherwise go back to top level
        // route and then go back to menu as deep routes won't be recognised in parent core animated pages element
        homeNavigation: function() {
          window.location.hash = 'menu';
        }
      });

    })();
  </script>
  </script>
</polymer-element>
