<polymer-element name="leaderboard-authentication" attributes="wide">
    <template>
        <link rel="stylesheet" href="leaderboard-authentication.css">

        <firebase-login id="login" user="{{user}}" statusKnown="{{statusKnown}}"
                        location="https://incandescent-heat-3687.firebaseio.com/" provider="{{provider}}"
                        on-error="{{error}}" on-user-created="{{userSuccess}}" on-password-changed="{{userSuccess}}"
                        on-password-reset="{{userSuccess}}" on-user-removed="{{userSuccess}}">
        </firebase-login>

        <div class="main" flex layout vertical fit?="{{!wide}}" >
            <div class="card  card--primary {{ {wide: wide} | tokenList }}" flex layout vertical>
                <div layout vertical flex>
                    <div class="indent" layout vertical>
                        <div class="header">
                            {{statusKnown && user && 'Edit Profile' || typeOfAuth }}
                        </div>
                        <div class="auth-checkbox">
                            <paper-checkbox id="authenticationType" class="auth-checkbox__checkbox" label="Create New User" on-change="{{ authStateChanged }}"></paper-checkbox>
                         </div>
                        <paper-input label="Name" floatinglabel value="{{name}}"
                                     type="name" id="name_input" layout vertical>
                        </paper-input>
                        <paper-input label="Email" validateImmediately="true" floatinglabel value="{{email}}"
                                     type="email" id="email_input" required layout vertical>
                        </paper-input>
                        <paper-input label="Password" validateImmediately="true" floatinglabel value="{{password}}"
                                     type="password" required id="password_input" layout vertical>
                        </paper-input>
                    </div>
                    <div horizontal center layout>
                        <paper-button on-tap="{{logout}}" label="Sign Out"  hidden?="{{!statusKnown || !user}}"></paper-button>
                        <div flex></div>
                        <paper-fab id="check" icon="check" hidden?="{{ typeOfAuth == 'Join Up' }}"
                                   on-tap="{{ login }}"
                                   showing?="{{ $.email_input.inputValue.length && $.password_input.inputValue.length }}">
                        </paper-fab>

                        <paper-fab id="check" icon="check" hidden?="{{ typeOfAuth == 'Sign In' }}"
                                   on-tap="{{ createUser }}"
                                   showing?="{{ $.name_input.inputValue.length && $.email_input.inputValue.length && $.password_input.inputValue.length}}">
                        </paper-fab>
                    </div>
                </div>
            </div>
        </div>

        <paper-toast text="{{loginValidationMessage}}" id="paper_toast"
                     class="core-transition core-transition-bottom" touch-action="none">
        </paper-toast>
    </template>
    <script>
        (function () {
            'use strict';

            Polymer({
                ready: function() {

                    var firebaseLogin = this.$.login;
                    var toast =  this.$.paper_toast;
                    var toastDuration =  3000;
                    var self = this;

                    this.provider = 'password';
                    this.loginValidationMessage = '';
                    this.typeOfAuth = 'Sign In';

                    // Set theming styles for Paper intput elements
                    CoreStyle.g.paperInput.focusedColor = CoreStyle.g.theme.primaryAccentColour;
                    CoreStyle.g.paperInput.invalidColor = CoreStyle.g.theme.primaryTextColour;

                    // When Create New User checkbox is changed
                    this.authStateChanged= function () {
                        if (this.$.authenticationType.checked) {
                            this.typeOfAuth = 'Join Up';
                        } else {
                            this.typeOfAuth = 'Sign In';
                        }
                    };

                    this.login = function () {
                        var params;
                        try {
                            params = JSON.parse( this.$.params.value);
                        } catch (e) {
                            params = null;
                        }
                        if (this.provider == 'password') {
                            params = this.params || {};
                            params.email = this.email;
                            params.password = this.password;
                        }
                        firebaseLogin.login(params);
                    };

                    this.logout = function () {
                        firebaseLogin.logout();
                    };

                    this.createUser = function () {
                        firebaseLogin.createUser(this.email, this.password);
                    };

                    this.removeUser = function () {
                        firebaseLogin.removeUser(this.email, this.password);
                    };

                    this.changePassword = function () {
                        firebaseLogin.changePassword(this.email, this.password, this.newPassword);
                    };

                    this.resetPassword = function () {
                        firebaseLogin.sendPasswordResetEmail(this.email);
                    };

                    this.error = function (e) {
                        setMessage('Error: ' + e.detail.message, true);
                    };

                    this.userSuccess = function (e) {
                        setMessage(e.type + ' success!', false);
                    };

                    function setMessage(msg, error) {
                        self.loginValidationMessage = msg;
                        toast.show();
                    }
                }
            });
        })();
    </script>
</polymer-element>