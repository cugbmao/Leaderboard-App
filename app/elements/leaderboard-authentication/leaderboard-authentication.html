<polymer-element name="leaderboard-authentication" attributes="wide">
  <template>
    <link rel="stylesheet" href="leaderboard-authentication.css">

    <firebase-login id="login" user="{{user}}" statusKnown="{{statusKnown}}"
                    location="https://incandescent-heat-3687.firebaseio.com/" provider="{{provider}}"
                    on-error="{{error}}" on-user-created="{{userSuccess}}" on-password-changed="{{userSuccess}}"
                    on-password-reset="{{userSuccess}}" on-user-removed="{{userSuccess}}">
    </firebase-login>
    <firebase-element id="user" location="{{'https://incandescent-heat-3687.firebaseio.com/users/' + user.uid}}"
                      dataReady="{{userReady}}">
    </firebase-element>
    <div class="main" flex layout vertical fit?="{{!wide}}">
      <div class="card  card--primary {{ {wide: wide} | tokenList }}" flex layout vertical>

        <h1>{{statusKnown && user && 'Edit Profile' || typeOfAuth }}</h1>

        <div class="auth-checkbox" hidden?="{{statusKnown && user}}">
          <paper-checkbox id="authenticationType" class="auth-checkbox__checkbox"
                          label="Create New User" on-change="{{ authTypeChanged }}">
          </paper-checkbox>
        </div>

        <leaderboard-signin id="signin" userDetails="{{userDetails}}"
                            email="{{email}}" password="{{password}}"
                            hidden?="{{ typeOfAuth == 'Join Up' || user }}"
                            on-signin-button-pressed="{{ signInHandler }}">
        </leaderboard-signin>

        <leaderboard-create-user id="createUser"  userDetails="{{userDetails}}"
                                 email="{{email}}" password="{{password}}"
                                 hidden?="{{ typeOfAuth == 'Sign In' && !user}}"
                                 on-create-user-button-pressed="{{ createUserHandler }}">
        </leaderboard-create-user>

        <div class="button-holder" horizontal center layout>
          <paper-button raised on-tap="{{logout}}" label="Sign Out" hidden?="{{ !user }}"></paper-button>
          <div flex></div>
          <paper-fab id="AuthButton" icon="check"
                     showing?="{{ user || ($.email_input.inputValue.length && $.password_input.inputValue.length)}}"
                     on-tap="{{ authUser }}"
          </paper-fab>
        </div>
      </div>
    </div>
    <paper-toast text="{{loginValidationMessage}}" id="paper_toast"
                 class="core-transition core-transition-bottom" touch-action="none">
    </paper-toast>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({

        observe: {
          'userReady': 'syncUser'
        },

        userDetails: {
          email: '',
          password: ''
        },

        ready: function () {

          var firebaseLogin = this.$.login;
          var toast = this.$.paper_toast;
          var toastDuration = 3000;
          var self = this;

          this.provider = 'password';
          this.loginValidationMessage = '';
          this.typeOfAuth = 'Sign In';

          // Set theming styles for Paper intput elements
          CoreStyle.g.paperInput.focusedColor = CoreStyle.g.theme.primaryAccentColour;
          CoreStyle.g.paperInput.invalidColor = CoreStyle.g.theme.primaryTextColour;

          // When Create New User checkbox is changed
          this.authTypeChanged = function () {
            if (this.$.authenticationType.checked) {
              this.typeOfAuth = 'Join Up';
            } else {
              this.typeOfAuth = 'Sign In';
            }
          };

          this.signInHandler = function() {
            firebaseLogin.login(this.userDetails)
          };

          this.createUserHandler = function() {
            firebaseLogin.createUser(this.userDetails.email, this.userDetails.password);
          };

          this.authUser = function () {
            if (this.user) {
              // Update profile and show user message.
              this.editProfile(true);

            } else if (this.typeOfAuth === 'Sign In') {
              this.login();

            } else {
              this.createUser();
            }
          };

          this.logout = function () {
            firebaseLogin.logout();
          };

          this.removeUser = function () {
            firebaseLogin.removeUser(this.email, this.password);
          };

          this.changePassword = function () {
            firebaseLogin.changePassword(this.email, this.password, this.newPassword);
          };

          this.resetPassword = function () {
            firebaseLogin.sendPasswordResetEmail(this.email);
          };

          this.error = function (event) {
            self.setMessage('Error: ' + event.detail.message, true);
          };

          // User Created Handler
          this.userSuccess = function (event) {
            this.signInHandler();
            this.setMessage(event.type + ' success!', false);
          };

          this.setMessage = function (msg, error) {
            self.loginValidationMessage = msg;
            toast.show();
          };
        },

        // Keep Firebase user element's data property updated
        syncUser: function () {
          if (this.user && this.userReady) {

            if (this.$.user.data) {
              this.email = this.user.email;
              this.handicap = this.$.user.data.handicap;
              this.name = this.$.user.data.name;
            }

            this.editProfile();

          } else {
            this.$.user.data = null;
          }
        },

        // Set data on Firebase user element.
        editProfile: function (showMessage) {

          this.$.user.data = {
            name: this.name || '',
            handicap: this.handicap || '',
            uid: this.user.uid || '',
            email: this.user.email || ''
          }

          if (showMessage) {
            this.setMessage('Profile Updated', false);
          }
        }
      });
    })();
  </script>
</polymer-element>
