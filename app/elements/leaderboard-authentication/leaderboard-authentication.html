<polymer-element name="leaderboard-authentication" attributes="wide statusKnown user userDetails">
  <template>
    <link rel="stylesheet" href="leaderboard-authentication.css">

    <firebase-login id="login" user="{{user}}" statusKnown="{{statusKnown}}"
                    location="https://incandescent-heat-3687.firebaseio.com/" provider="{{provider}}"
                    on-error="{{error}}" on-user-created="{{userSuccess}}" on-password-changed="{{userSuccess}}"
                    on-password-reset="{{userSuccess}}" on-user-removed="{{userSuccess}}">
    </firebase-login>

    <div class="main" flex layout vertical fit?="{{!wide}}">
      <div class="card  card--primary {{ {wide: wide} | tokenList }}" flex layout vertical
           slide-up-offscreen?="{{parentElement.selected === 'profile'}}" cross-fade="{{!wide && parentElement.selected !== 'profile'}}">
        <h1>{{statusKnown && user && 'Edit Profile' || typeOfAuth }}</h1>
        <div class="auth-checkbox" hidden?="{{statusKnown && user}}">
          <paper-checkbox id="authenticationType" class="auth-checkbox__checkbox"
                          label="Create New User" on-change="{{ authTypeChanged }}">
          </paper-checkbox>
        </div>

        <leaderboard-signin id="signin" userDetails="{{userDetails}}"
                            email="{{email}}" password="{{password}}"
                            hidden?="{{ typeOfAuth == 'Join Up' || user }}"
                            on-signin-button-pressed="{{ signInHandler }}">
        </leaderboard-signin>

        <leaderboard-create-user id="createUser"  userDetails="{{userDetails}}"
                                 email="{{email}}" password="{{password}}"
                                 name="{{name}}" handicap="{{handicap}}"
                                 hidden?="{{ typeOfAuth == 'Sign In' || user}}"
                                 on-create-user-button-pressed="{{ createUserHandler }}">
        </leaderboard-create-user>

        <leaderboard-edit-profile id="editProfile"  userDetails="{{userDetails}}"
                                  user="{{user}}"
                                  name="{{name}}" handicap="{{handicap}}"
                                  hidden?="{{!user}}"
                                  on-sign-out-button-pressed="{{ signOutHandler }}">
        </leaderboard-edit-profile>
      </div>
    </div>
    <paper-toast text="{{loginValidationMessage}}" id="paper_toast"
                 class="core-transition core-transition-bottom" touch-action="none">
    </paper-toast>
  </template>
  <script>
    (function () {
      'use strict';

      Polymer({

        authenticated: false,

        ready: function () {

          var firebaseLogin = this.$.login;
          var toast = this.$.paper_toast;
          var toastDuration = 3000;
          var self = this;

          this.provider = 'password';
          this.loginValidationMessage = '';
          this.typeOfAuth = 'Sign In';

          // Set theming styles for Paper input elements
          CoreStyle.g.paperInput.focusedColor = CoreStyle.g.theme.primaryAccentColour;
          CoreStyle.g.paperInput.invalidColor = CoreStyle.g.theme.primaryTextColour;

          // When Create New User checkbox is changed
          this.authTypeChanged = function () {
            if (this.$.authenticationType.checked) {
              this.typeOfAuth = 'Join Up';
            } else {
              this.typeOfAuth = 'Sign In';
            }
          };

          this.signInHandler = function() {
            firebaseLogin.login(this.userDetails)
          };

          this.createUserHandler = function() {
            firebaseLogin.createUser(this.userDetails.email, this.userDetails.password);
          };

          this.signOutHandler = function() {
            firebaseLogin.logout();
            this.userDetails = null;
            //this.user = null;
            this.email ='';
            this.password ='';
            this.name ='';
            this.handicap ='';
          };

          this.removeUser = function () {
            firebaseLogin.removeUser(this.email, this.password);
          };

          this.changePassword = function () {
            firebaseLogin.changePassword(this.email, this.password, this.newPassword);
          };

          this.resetPassword = function () {
            firebaseLogin.sendPasswordResetEmail(this.email);
          };

          this.error = function (event) {
            self.setMessage('Error: ' + event.detail.message, true);
          };

          // User Created Handler
          this.userSuccess = function (event) {
            this.signInHandler();
            this.setMessage(event.type + ' success!', false);
          };

          this.setMessage = function (msg, error) {
            self.loginValidationMessage = msg;
            toast.show();
          };
        }
      });
    })();
  </script>
</polymer-element>
