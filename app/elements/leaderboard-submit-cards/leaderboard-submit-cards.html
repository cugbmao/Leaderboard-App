<link rel="import" href="../../bower_components/polymer/polymer.html">

<polymer-element name="leaderboard-submit-cards"
                 attributes="activeTournament tournamentToScoreId roundToScoreId submitCardsGroupings">
  <template>
    <link rel="stylesheet" href="leaderboard-submit-cards.css">

    <section class="no-tournaments"
             cross-fade
             hidden?="{{activeTournament}}">
      There are no active tournaments with outstanding scorecards.
    </section>

    <section cross-fade
             hidden?="{{!activeTournament}}"
             id="activeTournamentsSection"
             class="active-tournaments-section  {{ {wide: wide} | tokenList }}"
             layout vertical>

     <template bind="{{activeTournament}}">
       <div class="tournament-name">{{name}}</div>
      </template>

      <template id="groupingTemplate" repeat="{{grouping, groupingIndex in groupings}}">
        <paper-shadow z="1" class="card">
          <div horizontal center layout class="card__header">
            <div class="grouping-info" vertical layout flex>
              <div class="grouping--name">Group {{groupingIndex + 1}}</div>
            </div>

            <paper-button on-tap="{{showGroupCard}}"
                          transition="core-transition-center">Card</paper-button>
            <paper-button on-tap="{{submitGroupCard}}"
                          groupingIndex="{{groupingIndex}}">Submit</paper-button>
          </div>

          <div class="divider"></div>

          <template repeat="{{player in grouping.players}}">
            <div class="players-list-item" horizontal center layout>
              <div class="player__info" layout horizontal flex>
                <div>{{player.name}}</div>
                <div class="player__handicap">{{player.handicap}}</div>
                <div flex layout horizontal end-justified class="player__scores">
                  <div class="player__scorecard">{{player.roundScorecardTotal}}</div>
                  <div class="player__score">{{player.roundScoreTotal}}pts</div>
                </div>
              </div>
            </div>
          </template>

        </paper-shadow>
      </template>

    </section>
  </template>
  <script>
    (function () {

      Polymer({

        // Collection of groupings in the active round
        groupings: [],

        // Grouping passed in from firebase
        submitCardsGroupings: null,

        // Tournament id that is currently active
        tournamentToScoreId: '',

        // Round id that is currently active
        roundToScoreId: '',

        // Current tournament object
        activeTournamentChanged: function() {

          this.activeTournament.rounds.forEach(this.getPendingRounds, this);

          if (this.groupings) {
            this.groupings.forEach(function(grouping) {
              grouping.players.forEach(this.getPlayerScores, this);
            }, this);
          }
        },

        // Iterate through rounds for pending round
        getPendingRounds: function(round) {

          // If the round is waiting for cards to be submitted
          if (round.roundStatus === 'pending') {

            this.getPendingGroups(round.groupings);

            this.setTournamentIds(round);
          }
        },

        // Iterate through groups and create groupings array
        getPendingGroups: function(groupings) {

          this.groupings = [];

          for (var groupingKey in groupings) {

            if (groupings[groupingKey].groupStatus === 'pending') {
              this.groupings.push(groupings[groupingKey]);
            }
          }
        },

        // Set the ids for the active tournament and pending round
        setTournamentIds: function(round) {

          this.tournamentToScoreId = this.activeTournament.id;
          this.roundToScoreId = round.roundId;
        },

        // Iterate through players and add score and scorecard totals to groupings players array
        getPlayerScores: function(player) {

          // If the round is waiting for cards to be submitted
          player.roundScoreTotal = this.getArrayTotal(player.roundScore);
          player.roundScorecardTotal = this.getArrayTotal(player.roundScorecard);
        },

        // Return sum of an array
        getArrayTotal: function(arrayToSum) {
          return arrayToSum.reduce(function(previousValue, currentValue) {
            return previousValue + currentValue;
          });
        },

        // Fired from parent element when grouping firebase data is updated
        submitCardsGroupingsUpdated: function () {

          this.getPendingGroups(this.submitCardsGroupings);

          if (this.groupings) {
            this.groupings.forEach(function(grouping) {
              grouping.players.forEach(this.getPlayerScores, this);
            }, this);
          }
        },

        // Set the grouping status for the active round to 'complete'
        // Update the groupings so view gets updated
        // Call update handicaps method
        submitGroupCard: function(event) {

        }
      });

    })();
  </script>
</polymer-element>
