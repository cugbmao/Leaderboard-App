<link rel="import" href="../../bower_components/polymer/polymer.html">

    <polymer-element name="leaderboard-tournament-manager" attributes="selected userDetails wide">
      <template>
        <link rel="stylesheet" href="leaderboard-tournament-manager.css">

        <core-style ref="section--content"></core-style>

        <firebase-element id="userHostedTournamentsFireBase"
                          location="{{'https://incandescent-heat-3687.firebaseio.com/users/' + userDetails.uid + '/hostedtournaments'}}"
                          dataReady="{{userHostedTournamentsReady}}"
                          data="{{userHostedTournaments}}">
        </firebase-element>

        <firebase-element id="tournamentsFireBase"
                          location="{{tournamentsLocation}}"
                          on-child-added="{{createUserTournamentIndex}}"
                          on-child-changed="{{updateTournaments}}"
                          limit="10"
                          childEvents log>
        </firebase-element>

    <div id="sectionPanel" class="section-panel {{ {wide: wide} | tokenList }}"
         flex vertical layout>

      <div class="background-fade  background-fade--themed"
           fit
           cross-fade></div>

      <div class="card" flex vertical layout hero-p>

        <core-toolbar class="menu-toolbar" hero-id="tournament-title" hero>

          <div class="section-title" flex cross-fade-delayed>{{sectionData[selected].title}}</div>

        </core-toolbar>

        <div id="sectionContent"
             class="section-content"
             flex
             hero-id="tournament-background"
             hero="{{!wide}}">

          <core-animated-pages class="tournament-manager-pages"
                               selected="{{selected}}"
                               transitions="slide-from-right"
                               auto>

            <leaderboard-manage-tournaments name="manageTournaments"
                                            hostedTournaments="{{hostedTournaments}}"
                                            tournamentToDelete="{{tournamentToDelete}}">
            </leaderboard-manage-tournaments>

            <leaderboard-tournament-details userDetails="{{userDetails}}"
                                            name="tournamentDetails"
                                            showClubSearchButton="{{showClubSearchButton}}"
                                            hostedTournamentToUpdate="{{hostedTournamentToUpdate}}"
                                            tournamentHash="{{tournamentHash}}">
            </leaderboard-tournament-details>

            <leaderboard-club-search id="clubSearch"
                                     name="clubSearch"
                                     chosenClub="{{chosenClub}}"
                                     searchTerm="{{searchTerm}}">
            </leaderboard-club-search>

            <leaderboard-choose-course id="chooseCourse"
                                       name="chooseCourse"
                                       showSaveTournamentButton="{{showSaveTournamentButton}}"
                                       userDetails="{{userDetails}}"
                                       hostedTournamentToUpdate="{{hostedTournamentToUpdate}}"
                                       chosenClub="{{chosenClub}}"
                                       wide="{{wide}}"
                                       on-set-hosted-tournament="{{setHostedTournament}}">
            </leaderboard-choose-course>

          </core-animated-pages>

        </div>

        <paper-fab icon="add"
                   showing?="{{selected === 'manageTournaments'}}"
                   on-tap="{{addTournamentButtonHandler}}">
        </paper-fab>

        <paper-fab id="StartHostedTournamentButton"
                   icon="check"
                   showing?="{{ selected === 'tournamentDetails' && showClubSearchButton }}"
                   on-tap="{{ detailsButtonHandler }}">
        </paper-fab>

        <paper-fab id="ClubSearchButton"
                   icon="search"
                   showing?="{{ selected === 'clubSearch' && searchTerm.length > 2 }}"
                   on-tap="{{ clubSearchButtonHandler }}">
        </paper-fab>

        <paper-fab id="SaveTournamentButton"
                   icon="add"
                   showing?="{{ selected === 'chooseCourse' && showSaveTournamentButton }}"
                   on-tap="{{ saveTournamentButtonHandler }}">
        </paper-fab>

        <paper-icon-button class="back-button"
                           icon="arrow-back"
                           on-tap="{{backNavigation}}"
                           hero-id="tournament-back-button"
                           hero>
        </paper-icon-button>

        <paper-icon-button class="home-button"
                           icon="home"
                           on-tap="{{homeNavigation}}"
                           cross-fade>
        </paper-icon-button>
      </div>

    </div>
  </template>
  <script>
    (function () {

      Polymer({

        observe: {
          'userHostedTournaments': 'getHostedTournaments'
        },

        showClubSearchButton: false,

        showSearchTermButton: false,

        showSaveTournamentButton: false,

        newTournament: true,

        selected: 'manageTournaments',

        tournamentsLocation: 'https://incandescent-heat-3687.firebaseio.com/tournaments/',

        hostedTournamentToUpdate: {},

        hostedTournaments: [],

        tournamentToDelete: '',

        sectionData: {
          'manageTournaments': {
            'backNavigation': 'menu',
            'title': 'Tournament Manager'
          },
          'tournamentDetails': {
            'backNavigation': 'manageTournaments',
            'title': 'Tournament Details'
          },
          'clubSearch': {
            'backNavigation': 'tournamentDetails',
            'title': 'Find Golf Club'
          },
          'chooseCourse': {
            'backNavigation': 'clubSearch',
            'title': 'Choose Course'
          }
        },

        // Triggered when a new tournament is created
        setHostedTournament: function() {

          // Add tournament to Firebase
          this.$.tournamentsFireBase.location = this.tournamentsLocation;
          this.$.tournamentsFireBase.push(this.hostedTournamentToUpdate);

          // Navigate to Manage Tournaments home view
          this.selected = 'manageTournaments';
          history.pushState(null, null, '#tournament-manager');
        },

        // Called when a new tournament is pushed to the Firebase tournaments area
        createUserTournamentIndex: function(event) {

          var tournament;

          if (this.userDetails) {

            // Add an id property using the key to make data retrieval easier
            if (!event.detail.value.id) {

              tournament = new Firebase(this.tournamentsLocation + event.detail.name);

              tournament.once('value', function(snapshot) {
                var result = snapshot.val();
                result.id = event.detail.name;
                tournament.set(result);
              });
            }

            this.userHostedTournaments = this.userHostedTournaments || {};
            this.userHostedTournaments[event.detail.name] = true;
          }
        },

        // When userHostedTournamentsFireBase data is ready iterate through keys to retrieve tournament data
        getHostedTournaments: function() {

          var tournament;
          var self = this;
          this.hostedTournaments = [];

          for (var tournamentKey in this.userHostedTournaments) {
            tournament = new Firebase(this.tournamentsLocation + tournamentKey);
            tournament.once('value', function(snap) {
              var result = snap.val();
              self.hostedTournaments.push(result);
            });
          }
        },

        // When a tournament is changed
        updateTournaments: function(event) {
          this.getHostedTournaments();
        },

        // delete tournament from Firebase
        tournamentToDeleteChanged: function() {
          if (this.tournamentToDelete.length) {
            delete this.userHostedTournaments[this.tournamentToDelete];
            this.$.tournamentsFireBase.data[this.tournamentToDelete] = null;
            this.getHostedTournaments();
          }
        },

        // Handler for back button in toolbar
        backNavigation: function() {
          if (this.selected === 'manageTournaments') {
            this.homeNavigation();
          } else {
            this.selected = this.sectionData[this.selected].backNavigation;
          }
        },

        // Handler for home button in toolbar
        homeNavigation: function() {
          this.parentElement.selected = 'menu';
        },

        // Handler for Fab button on manager page
        addTournamentButtonHandler: function() {
          this.selected = 'tournamentDetails';
          history.pushState(null, null, '#tournament-manager');
        },

        // Handler for Fab button on details page
        detailsButtonHandler: function() {
          if (this.newTournament) {
            this.selected = 'clubSearch';
            history.pushState(null, null, '#tournament-manager');
          }
        },

        // Handler for Fab button on courses page
        saveTournamentButtonHandler: function() {
          this.$.chooseCourse.saveTournament();
        },

        // Handler for Fab button on search page
        clubSearchButtonHandler: function() {
          this.$.clubSearch.searchClubs();
        },

        // Called when a user selects a result from the Club search
        chosenClubChanged: function() {
          if (this.chosenClub) {
            this.selected = 'chooseCourse';
            history.pushState(null, null, '#tournament-manager');
          }
        }
      });

    })();
  </script>
</polymer-element>
